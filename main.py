import json
from callgraph import Callgraph
from iggraph import IGGraph

import argparse

def main(project_base_dir: str, callgraph_json: str):
    # project_base_dir is used to resolve the absolute path of files in callgraph json
    callgraph = Callgraph(callgraph_json, project_base_dir)
    graph = IGGraph(callgraph)
    partitioned = graph.partition()

    # 把分割出来的子图写入json
    json.dump(partitioned, open('partitioned.json', 'w'))
    for cluster in partitioned:
        print('---')
        for func in cluster:
            print(func)
            # print(func.def_site)
            # print(func.filepath)
            # print(func.summary)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(description="Node malware detection")
    parser.add_argument("--base-dir", type=str, help="Base directory path")
    parser.add_argument("--callgraph-json", type=str,
                        help="Call graph JSON file generated by Jelly")
    args = parser.parse_args()

    if not args.base_dir:
        parser.error("--base-dir is required.")
    if not args.callgraph_json:
        parser.error("--callgraph-json is required.")

    main(args.base_dir, args.callgraph_json)
